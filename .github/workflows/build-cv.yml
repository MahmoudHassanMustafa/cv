name: Build CV PDF

on:
    push:
        branches:
            - main
        paths:
            - "cv.tex"
            - "sections/**.tex"
            - ".github/workflows/build-cv.yml"
    workflow_dispatch:

# Cancel in-progress builds when a new commit is pushed
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: write # Needed to deploy to gh-pages
    actions: write

jobs:
    build:
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Compile LaTeX document
              uses: xu-cheng/latex-action@v3
              with:
                  root_file: cv.tex
                  latexmk_use_xelatex: false
                  latexmk_shell_escape: false
                  args: -pdf -file-line-error -interaction=nonstopmode -halt-on-error

            - name: Check compilation output
              if: failure()
              run: |
                  echo "=== LaTeX Log ==="
                  cat cv.log || echo "No log file found"

            - name: Generate artifact name with timestamp
              id: artifact-name
              run: |
                  TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
                  echo "name=CV_$TIMESTAMP" >> $GITHUB_OUTPUT
                  echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

            - name: Upload PDF artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ steps.artifact-name.outputs.name }}
                  path: cv.pdf
                  retention-days: 30
                  if-no-files-found: error

            - name: Upload to latest
              uses: actions/upload-artifact@v4
              with:
                  name: CV-latest
                  path: cv.pdf
                  retention-days: 90
                  if-no-files-found: error

            - name: Prepare deployment directory
              if: github.ref == 'refs/heads/main'
              run: |
                  mkdir -p deploy
                  cp cv.pdf deploy/
                  ls -lh deploy/

            - name: Deploy PDF to GitHub Pages
              if: github.ref == 'refs/heads/main'
              uses: peaceiris/actions-gh-pages@v4
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  publish_dir: ./deploy
                  publish_branch: gh-pages
                  force_orphan: true
                  user_name: github-actions[bot]
                  user_email: github-actions[bot]@users.noreply.github.com

            - name: Generate shareable link
              if: github.ref == 'refs/heads/main'
              run: |
                  REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
                  USER_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f1)
                  echo "âœ… CV deployed successfully!"
                  echo "ðŸ”— Shareable link: https://$USER_NAME.github.io/$REPO_NAME/cv.pdf"
                  echo ""
                  echo "::notice title=ðŸ“„ CV Ready::Your CV is available at: https://$USER_NAME.github.io/$REPO_NAME/cv.pdf"
